<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Synap App</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="app.js" defer></script>
</head>
<body>

    <header class="topbar">
        <div class="brand">Synap</div>
        <div class="user-profile">
            <span class="user-name">...</span>
            <button onclick="handleLogout()" class="btn-logout">Esci</button>
        </div>
    </header>

    <main>
        <section id="view-login" class="view active">
            <div class="card">
                <h1>Benvenuto</h1>
                <p class="status-text">Entra nel futuro dei trasporti</p>
                <form id="login-form">
                    <input type="email" id="email" placeholder="Email" required>
                    <input type="password" id="password" placeholder="Password" required>
                    <button type="submit" class="btn primary">Accedi</button>
                </form>
                <div style="margin-top: 20px;">
                    <p>Non hai un account?</p>
                    <button onclick="showView('register')" class="link">Crea un account</button>
                </div>
            </div>
        </section>

        <section id="view-register" class="view">
            <div class="card">
                <h1>Crea Account</h1>
                <p class="status-text">Unisciti a Synap</p>
                <form id="register-form">
                    <input type="text" id="reg-name" placeholder="Il tuo Nome" required>
                    <input type="email" id="reg-email" placeholder="Email" required>
                    <input type="password" id="reg-password" placeholder="Password" required>
                    <button type="submit" class="btn primary">Registrati</button>
                </form>
                <button onclick="showView('login')" class="link" style="margin-top: 15px;">Torna al Login</button>
            </div>
        </section>

        <section id="view-home" class="view">
            <div class="card">
                <p class="status-text">Il tuo saldo disponibile</p>
                <div class="balance">
                    <span id="balance-amount">0.00</span> 
                    <span class="currency">IOTA</span>
                </div>
                
                <div id="debt-warning" style="display: none; background: #FF3B30; color: white; padding: 15px; border-radius: 12px; margin-top: 15px; box-shadow: 0 4px 10px rgba(255, 59, 48, 0.3);">
                    <div style="font-weight: bold; font-size: 1.1rem; margin-bottom: 5px;">
                        ‚ö†Ô∏è DEBITO: <span id="debt-amount">0.00</span> IOTA
                    </div>
                    <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 10px;">
                        Non puoi viaggiare finch√© non saldi.
                    </div>
                    <button onclick="handlePayDebt()" style="background: white; color: #FF3B30; border: none; padding: 8px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%;">
                        üí∏ Usa Saldo per Pagare
                    </button>
                </div>
            </div>
            
            <button onclick="startScanner('START')" class="btn primary">üì∑ Inizia Viaggio (IN)</button>
        </section>

        <section id="view-scan" class="view">
            <h2 style="margin-bottom: 20px;">Scansiona QR</h2>
            
            <div id="reader"></div> 
            
            <div id="passenger-selector-container" class="card" style="margin-bottom: 15px; padding: 15px;">
                <p class="status-text" style="margin-bottom: 10px;">Numero Viaggiatori</p>
                <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                    <button onclick="changePassenger(-1)" class="btn secondary" style="width: 50px; margin:0;">-</button>
                    <span id="passenger-count-display" style="font-size: 2rem; font-weight: bold;">1</span>
                    <button onclick="changePassenger(1)" class="btn primary" style="width: 50px; margin:0;">+</button>
                </div>
            </div>

            <div class="card">
                <p class="status-text">Oppure inserisci codice</p>
                <input type="text" id="manual-code-input" placeholder="Es. IN-BUS-01">
                <button onclick="handleManualEntry()" class="btn secondary">Conferma Manuale</button>
                <button onclick="showView('home')" class="btn link" style="margin-top:10px">Annulla</button>
            </div>
        </section>

        <section id="view-trip" class="view">
            <div class="card pulsate">
                <div style="font-size: 50px;">üöå</div>
                <h2>In Viaggio</h2>
                
                <div style="background: #f1f3f5; border-radius: 8px; padding: 10px; margin: 15px 0; border: 1px solid #ddd;">
                    <p style="margin: 0; font-size: 0.8rem; color: #666; text-transform: uppercase; letter-spacing: 1px;">Tratta Attiva</p>
                    <strong id="trip-route-display" style="font-size: 1.3rem; color: #007bff; display: block; margin-top: 5px;">--</strong>
                </div>
                
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 0.9rem; color: #555;">
                    <span>Veicolo: <strong id="trip-id-display">--</strong></span>
                    <span>Passeggeri: <strong id="trip-passengers-display">1</strong> üë§</span>
                </div>
                
                <div class="live-stats" style="margin: 20px 0; border-top: 1px solid #eee; padding-top: 20px;">
                    <div id="trip-timer" class="timer">00:00</div>
                    
                    <p style="font-size: 1.5rem; margin: 10px 0;">
                        <strong id="trip-cost" style="color: var(--primary);">0.00</strong> <small>IOTA</small>
                    </p>

                    <div style="background: #f0f0f5; padding: 5px 10px; border-radius: 8px; display: inline-block;">
                        <span style="color: #666; font-size: 0.9rem;">Tariffa: </span>
                        <strong id="trip-rate-display" style="color: #333;">--</strong> 
                        <span style="font-size: 0.8rem;"> IOTA/s</span>
                    </div>
                </div>
            </div>

            <div style="width: 100%; margin-top: auto;">
                <button onclick="startScanner('END')" class="btn danger">SCENDI E PAGA (OUT)</button>
                <button onclick="endTrip('OUT-DEBUG-FORCE')" class="link" style="color: #999; margin-top: 20px;">
                    (Debug) Forza Fine Corsa
                </button>
            </div>
        </section>

        <section id="view-result" class="view">
            <div class="ticket card"></div>
        </section>
    </main>
</body>
</html>